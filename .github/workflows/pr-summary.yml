name: PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  summary:
    runs-on: ubuntu-latest

    steps:
      - name: Generate PR summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const maxFiles = 20;
            const fileLines = files.slice(0, maxFiles).map((f) => {
              const sign = f.status === 'added' ? '+' : f.status === 'removed' ? '-' : '~';
              return `- ${sign} \`${f.filename}\` (+${f.additions} / -${f.deletions})`;
            });

            const body = [
              '## ðŸ§¾ PR Quick Summary',
              '',
              `- Title: ${pr.title}`,
              `- Changed files: ${files.length}`,
              `- Additions: +${pr.additions}`,
              `- Deletions: -${pr.deletions}`,
              '',
              '### Files',
              ...fileLines,
              files.length > maxFiles ? `- ...and ${files.length - maxFiles} more` : '',
            ].filter(Boolean).join('\n');

            const marker = '<!-- pr-quick-summary -->';
            const finalBody = `${marker}\n${body}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              per_page: 100,
            });

            const existing = comments.find((c) => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: finalBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: finalBody,
              });
            }
